# PagerDuty to Lightstep Incident Response Migration Tool

This tool is intended to assist in the migration from the PagerDuty platform
to the Lightstep Incident Response (LIR) platform. When executed, this tool 
will copy the following from PagerDuty to Lightstep Incident Response:
- Users
- Teams
- Services
- Schedules
- Escalation Policies

## Executing the Tool

### Modes
This tool can run in a `noop` mode and an `migrate` mode. `noop` will show you 
what will be created in LIR from PagerDuty, and `migrate` will actually 
create these objects in LIR.

### Requirements
- [PagerDuty API Key](https://support.pagerduty.com/docs/api-access-keys#section-generate-a-general-access-rest-api-key)
- Lightstep Incident Response Access Key
- URL of Lightstep Incident Response endpoint
- Docker and Docker Compose, or Python 3.9 (or greater)

#### Tested Versions
This code was tested on the following versions of software:
1. Python 3.9.9 (package versions outlined in requirements.txt)
2. PagerDuty API V2
3. Lightstep Incident Response January 18 2022 Release
4. Docker Desktop 4.1

### Setup
In the root of this repository, there is a file called `.env.example`. Rename this file
to `.env`, and replace the values of the file with your keys/url.

### Running with Docker Compose
The easiest way to run this code is via Docker Compose. From the root of the repo,
run:

```docker-compose build noop```
to build the container, followed by
```docker-compose run noop```
to execute the code in `noop` mode.

To run the migration, simply replace `noop` in the above command with `migrate`.

If you are developing against this repo, run `docker-compose run test` to run unit tests.

### Running with Python Locally
It is also possible to run this code without Docker. It is recommended to use a virtual
environment for this, if you chose this method. Please also note the requirements
section above; this code was written and tested in Python 3.9. It may not work
as expected on other versions.

From the root of this repository:
```python -m venv venv```
will build a virtual environment called `venv`. To activate it, run
```source venv/bin/activate```
You can now run the following to install the required packages to the virtual env:
```pip3 install -r requirements.txt```
Once packages are installed, you can run the following command (note: this assumes
that you have set your PagerDuty API key, Lightstep Incident Response token, and Lightstep Incident Response URL in your environment.
Replace environment variables here as necessary):
```
python3 -m cli.cli --pd $PAGERDUTY_API_KEY --lirtoken $LIR_TOKEN --apiurl $LIR_URL --noop
```
This will run the code in `noop` mode. In order to run the migration, remove the `--noop` flag.

#### Argument Descriptions

- `--pd` (required): PagerDuty API key for target account. See [this documentation link](https://support.pagerduty.com/docs/api-access-keys#section-generate-a-general-access-rest-api-key) for how to aquire this
- `--lirtoken` (required): Lightstep Incident Response API access token. Generated by a LIR administrator
- `--apiurl` (required): Lightstep Incident Response API URL. This should look like `https://lirexample.com` and should not include additional paths or trailing slashes
- `--noop` (optional): Run the LIR Migration tool in noop mode. Objects will not be created; only an output of what _would_ be created as well as any error or warning logs will be output to console. Excluding this argument will cause objects to be created in LIR.

## Caveats

There are some caveats to the operation of this tool that should be noted. Due to
Lightstep Incident Response and PagerDuty being different tools, there are some operations that are performed
in this code that may be unexpected and should be noted.

- If a PagerDuty user does not have a last name, their last name in LIR will be a
  duplicate of their first name (as first and last are required in LIR). For example,
  if a PagerDuty user is just "Joe", they will become "Joe Joe" in LIR.
- If there are multiple managers for a PagerDuty team, one will be selected as the
  manager of the LIR team. A team in LIR can only have one manager. If a PagerDuty team does not have
  a manager, one will be selected.
- In LIR, a team should be associated with a service. If there is no team associated to
  a PagerDuty service, but the PagerDuty service has an escalation policy, a team
  will be inferred from the policy and assigned to the service in LIR. If a team
  and policy are NOT present on a PagerDuty service, the service will be created without
  a team, and the name of the service will reflect that.
- If a PagerDuty schedule does not have a team associated with it, a team will be created
  based off of the users on the schedule.
- For a PagerDuty schedule, if there is no end date, the end date in LIR will be set
  for 5 years in the future.
- For a PagerDuty schedule, if there are daily or weekly restrictions placed, please ensure that 
  the schedule in LIR is accurate. Restricted schedules may require manual reconciliation.
- Users in a PagerDuty schedule will only be added to an LIR schedule if they are part
  of the team associated with the schedule.
- If no users for a PagerDuty escalation can be extracted from the team or schedule, it
  will be considered to not have an audience, and will not be created in LIR and will
  be logged as a warning.
